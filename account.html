<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <title>cryyptech</title>
    <style>

        *{
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }

        body{
        background-color: rgb(34, 48, 59);
        padding: 10px 0;
        font-family: Arial, sans-serif;
        }

        header{
        display: flex;
        align-items: center;
        justify-content: center;
        position: fixed;
        top: 0;
        width: 100%;
        background-color: rgba(58, 93, 121, 0.932);
        padding: 15px 0;
        }

      .back {
        position: absolute;
        left: 18px;
        font-size: 20px;
        color: rgb(181, 217, 252);
        cursor: pointer;
      }

        footer {
        display: flex;
        justify-content: space-around;
        align-items: center;
        position: fixed;
        bottom: 0;
        width: 100%;
        background-color: rgba(58, 93, 121, 0.932);
        padding: 0 0 5px 0;
      }

      .head{
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .img{
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        font-size: 30px;
        width: 130px;
        height: 130px;
        border-radius: 65px;
        background-color: rgb(58, 93, 121);
        color: rgb(34, 48, 59);
      }

      .container{
        margin: 60px 0;
        padding: 0 7px;
      }

      .body{
        background-color: rgba(58, 93, 121, 0.932);
        padding: 1px 9px;
        margin:  40px 10px;
        border-radius: 8px;
        overflow: hidden;
      }

      .innercon{
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        padding: 16px 10px;
        border-bottom: 0.5px solid #ccc;
        font-size: 20px;
        color: rgb(223, 223, 223);
      }

      .del{
        justify-content: center;
        text-align: center;
        color: red;
      }

      .log{
        color: rgb(192, 192, 192);
      }

      .bottom{
        border: none;
      }

      .val{
        margin-right: 13px;
        color: rgb(141, 141, 141);
      }

      .customAlert {
          display: none;
          justify-content: center;
          align-items: center;
          flex-direction: column;
          padding: 20px;
          background-color: rgba(0, 0, 0, 0.753);
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          z-index: 1000;
        }

      .messagediv{
        display: block;
        background-color: hsl(327, 90%, 28%);
        color: white;
        padding: 10px 20px;
        margin: 10px;
        margin-bottom: -40px;
        border-radius: 5px;
        font-size: 1rem;
        opacity: 0;
        animation: fadeOut 7s forwards;
      }

      footer {
        display: flex;
        justify-content: space-around;
        align-items: center;
        position: fixed;
        bottom: 0;
        width: 100%;
        background-color: rgba(58, 93, 121, 0.932);
        padding: 0 0 5px 0;
      }

      .footicn {
        font-size: 23px;
        color: #030c1d;
      }

      .footdiv{
        display: flex;
        padding: 12px 40px;
        align-items: center;
      }
    </style>
</head>
<body>
    <header>
      <i class="fa fa-chevron-left back" id="back"></i>
        <h3>Account</h3>
    </header>

    <div class="container">
      <div class="head">
        <div class="img">
          <h1>C</h1>
        </div>
      </div>
      <div class="body">
        <div class="innercon">
          <p >username</p>
          <p class="val a" id="usern">unknown</p>
        </div>
        <div class="innercon">
          <p >UID</p>
          <p class="val b" id="useruid">unknown</p>
        </div>
        <div class="innercon">
          <p>Country</p>
          <p class="val c" id="cnval">United States</p>
        </div>
        <div class="innercon bottom">
          <p>Currency</p>
          <p class="val d" id="crval">USD</p>
        </div>
      </div>
      
      <div class="messagediv" id="logoutMessage" style="display: none;" ></div>
    </div>
      <div class="body" id="logoutButton">
        <div class="innercon del bottom">
          <p class="log">Log Out</p>
        </div>
      </div>
      <div class="messagediv" id="deleteAccountMessage" style="display: none;"></div>
    </div>
      <div class="body" id="deleteAccountButton">
        <div class="innercon del bottom">
          <p>delete account</p>
        </div>
      </div>

    <footer>
      <div class="footdiv note" onclick="window.location.href = 'notification.html'"><i class="fa-solid fa-bell footicn nt" ></i></div>
      <div class="footdiv home" onclick="window.location.href = 'wallet.html'"><i class="fa-solid fa-house footicn hm"></i></div>
      <div class="footdiv set" onclick="window.location.href = 'setting.html'"><i class="fa-solid fa-gear footicn st"></i></div>
    </footer>
  </body>
  <script>
    document.getElementById('back').addEventListener('click', () => {
          window.history.back();
    })



    const footdivs = document.querySelectorAll('.footdiv');

    footdivs.forEach((footdiv) => {
      footdiv.addEventListener('mouseover', () => {
        footdiv.style.backgroundColor = 'rgb(34, 48, 59)';
        footdiv.querySelector('.footicn').style.color = '#bdd3fd'
      });

      footdiv.addEventListener('mouseout', () => {
        footdiv.style.backgroundColor = '';
        footdiv.querySelector('.footicn').style.color = ''
      })

      footdiv.addEventListener('click', () => {
        footdiv.style.backgroundColor = 'rgb(34, 48, 59)';
        footdiv.querySelector('.footicn').style.color = '#bdd3fd'
      })
    })

    const UserUID = localStorage.getItem('UserUID');
    document.getElementById('useruid').innerHTML = UserUID

    const Userinfo = JSON.parse(localStorage.getItem('userInfo'));
    const Usersname = Userinfo.username;
    document.getElementById('usern').innerHTML = Usersname

    const cont = localStorage.getItem('selectedCountryText');
    document.getElementById('cnval').innerHTML = cont

    const curr = localStorage.getItem('selectedCurrencyText');
    document.getElementById('crval').innerHTML = curr
  </script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, signOut, deleteUser, reauthenticateWithCredential, EmailAuthProvider, onAuthStateChanged  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getDatabase, ref, remove } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyB4MlVTAn20BKgG49nIhaB5dP08ycV6Tdg",
      authDomain: "cryyptechh.firebaseapp.com",
      projectId: "cryyptechh",
      storageBucket: "cryyptechh.appspot.com",
      messagingSenderId: "70442732438",
      appId: "1:70442732438:web:f4cf4c8043c3180421abb7"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    window.onload = function() {
  onAuthStateChanged(auth, (user) => {
    if (user) {
    } else {
      window.location.href = 'index.html';
    }
  });
}

    document.getElementById('logoutButton').addEventListener('click', () => {
      const confirmlogout = confirm("Are you sure you want to logout?");

      if (confirmlogout) {
        logoutUser();
      }
    });

    function logoutUser() {
      signOut(auth).then(() => {
        localStorage.clear();
        window.location.href = 'index.html';
      }).catch((error) => {
        console.error('Error signing out:', error);
        showMessage('Error signing out. Please try again.', 'logoutMessage');
      });
    }


    function reauthenticateUser() {
      const user = auth.currentUser;
      const credential = EmailAuthProvider.credential(
        user.email,
        prompt('Please enter your password again:')
      );

      return reauthenticateWithCredential(user, credential);
    }

    function deleteUserAccount() {
      const user = auth.currentUser;

      if (user) {
        reauthenticateUser()
          .then(() => {
            const userId = user.uid;

            // Create references to all user-related data
            const userRef = ref(db, 'users/' + userId);
            const preferencesRef = ref(db, 'preferences/' + userId);
            const defaultNotetimeRef = ref(db, 'defaultnotetime/' + userId);
            const extradataRef = ref(db, 'extradata/' + userId);
            const notificationsRef = ref(db, 'notifications/' + userId);
            const UserUID = JSON.parse(localStorage.getItem('UserUID'));
            const uidRef = ref(db, `uids/${UserUID}`);
            console.log('Removing uid data from uids/' + userId + 'uidd' + UserUID);

            // Delete all user-related data in parallel
            Promise.all([
          remove(userRef).then(() => console.log('User data removed')).catch(err => console.error('Error removing user data:', err)),
          remove(preferencesRef).then(() => console.log('Preferences removed')).catch(err => console.error('Error removing preferences:', err)),
          remove(defaultNotetimeRef).then(() => console.log('Default notetime removed')).catch(err => console.error('Error removing default notetime:', err)),
          remove(uidRef).then(() => console.log('UID removed')).catch(err => console.error('Error removing UID:', err)),
          remove(extradataRef).then(() => console.log('Extra data removed')).catch(err => console.error('Error removing extra data:', err)),
          remove(notificationsRef).then(() => console.log('Notifications removed')).catch(err => console.error('Error removing notifications:', err))
        ])
          })
        .then(() => {
          return deleteUser(user);
        })
        .then(() => {
          localStorage.clear();
          window.location.href = 'index.html';
        })
        .catch((error) => {
          // Handle any errors that occur
          console.error('Error deleting account:', error);
          showMessage('Error deleting account. Please try again.', 'deleteAccountMessage');
        });
      } else {
        console.error('No user is currently signed in.');
        showMessage('No user is currently signed in.', 'deleteAccountMessage');
      }
    }

    // Event listener for the delete account button
    document.getElementById('deleteAccountButton').addEventListener('click', () => {
      // Confirm the action with the user
      const confirmDelete = confirm("Are you sure you want to delete your account? This action cannot be undone.");

      if (confirmDelete) {
        deleteUserAccount();
      }
    });

    // Optional: Define showMessage function for displaying messages to the user
    function showMessage(message, divid) {
      let messageDiv = document.getElementById(divid);
      if (messageDiv) {
        messageDiv.style.display = 'block';
        messageDiv.innerHTML = message;
        messageDiv.style.opacity = 1;
        setTimeout(() => {
          messageDiv.style.opacity = 0;
          messageDiv.style.display = 'none';
        }, 5000);
      } else {
        console.error(`Element with id ${divid} not found.`);
      }
    }
</script>

</body>
</html>